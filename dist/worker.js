(function(){"use strict";var K=Object.defineProperty,V=(t,s,o)=>s in t?K(t,s,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[s]=o,i=(t,s,o)=>(V(t,typeof s!="symbol"?s+"":s,o),o),L=(t,s,o)=>{if(!s.has(t))throw TypeError("Cannot "+o)},E=(t,s,o)=>(L(t,s,"read from private field"),o?o.call(t):s.get(t)),c=(t,s,o)=>{if(s.has(t))throw TypeError("Cannot add the same private member more than once");s instanceof WeakSet?s.add(t):s.set(t,o)},C=(t,s,o,n)=>(L(t,s,"write to private field"),n?n.call(t,o):s.set(t,o),o);const j=self,p=!!j.WorkerGlobalScope,Q=p||`${self.name??""}`.startsWith("portal"),B={MAXIMIZE:"maximize",MINIMIZE:"minimize",RESTORE:"restore",SET_BADGE:"setBadge",CLOSE:"closeApp",ON_MAXIMIZE:"maximize",ON_MINIMIZE:"minimize",ON_RESTORE:"restore"},b="connection",Y={DISCONNECT:b+".disconnect",ON_DISCONNECT:b+".onDisconnect"},a="element",Z={ADD:a+".add",FIND:a+".find",EXISTS:a+".exists",REMOVE:a+".remove",REPLACE:a+".replace",ADD_STYLES:a+".addStyles",RESTORE_STYLES:a+".restoreStyles",REMOVE_CLASSES:a+".removeClasses",QUERY:a+".query",ON_TOGGLE:a+".onToggle",ON_MUTATION:a+".onMutation",ON_CLICK:a+".onClick",ON_MOUSE_OVER:a+".onMouseOver",ON_HOVER:a+".onHover",ON_MOUSEDOWN:a+".onMouseDown",ON_MOUSEUP:a+".onMouseUp"},m="cookie",A="sessionStorage",x="localStorage",G="cookieStore",z={GET_COOKIE:m+".getItem",SET_COOKIE:m+".setItem",GET_SESSION_STORAGE_ITEM:A+".getItem",SET_SESSION_STORAGE_ITEM:A+".setItem",GET_LOCAL_STORAGE_ITEM:x+".getItem",SET_LOCAL_STORAGE_ITEM:x+".setItem",GET_COOKIE_STORE_ITEM:G+".get",SET_COOKIE_STORE_ITEM:G+".set",ON_COOKIE_CHANGE:m+".onChange",ON_SESSION_STORAGE_CHANGE:A+".onChange",ON_LOCAL_STORAGE_CHANGE:x+".onChange",ON_COOKIE_STORE_CHANGE:G+".onChange"},v="window",X={GET_URL:v+".getUrl",ON_URL_CHANGE:v+".onUrlChange"},f=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var s=Math.random()*16|0,o=t=="x"?s:s&3|8;return o.toString(16)}),U={PUSH:"pushNotification",CLEAR:"clearNotifications",ON_CLICK:"notificationClick"},w={SET_RESOURCE:"setResource",CLEAR_RESOURCE:"clearResource",ON_CHANGE:"resourceChange"},H={GET_SESSION:"getSession",ON_CHANGE:"sessionChange"},d={SET_ITEM:"setStoreItem",GET_ITEM:"getStoreItem",REMOVE_ITEM:"removeStoreItem",...z},R={ECHO:"echo",REQUEST_PERMISSIONS:"requestPermissions",SEND_MESSAGE:"sendMessage",OPEN_APP:"openApp",ON_MESSAGE:"message"},k={SET_USER:"setUser",ON_CHANGE:"userChange"},D="0.4.4";var I,_,N,T,g,y,u,P,M;class ${constructor(s,o,n){i(this,"id"),c(this,I,null),c(this,_,[]),c(this,N,new Map),c(this,T,new Map),c(this,g,0),c(this,y,"*"),c(this,u,void 0),i(this,"openApp",(e,r)=>this.sendRequest(R.OPEN_APP,{appId:e,message:r})),c(this,P,(e,r,h=E(this,g))=>new Promise((S,O)=>{let l=null;h&&(l=setTimeout(()=>{O(new Error("timeout"))},h)),E(this,N).set(e,{path:r,timer:l,resolve:S,reject:O})})),c(this,M,async e=>{if(E(this,_).push(e),clearTimeout(E(this,I)),E(this,_).length>=10){this.postMessage({batch:E(this,_)}),E(this,_).length=0;return}C(this,I,setTimeout(()=>{this.postMessage({batch:E(this,_)}),E(this,_).length=0},1))}),i(this,"postMessage",e=>{p?E(this,u).postMessage(e):Q&&E(this,u).postMessage(e,E(this,y))}),i(this,"setContext",e=>{C(this,u,e)}),i(this,"sendRequest",async(e,...r)=>{const h=f();return E(this,M).call(this,{id:h,path:e,version:D,args:r}),E(this,P).call(this,h,e)}),i(this,"subscribe",(e,r="*",h)=>{const S=f();return E(this,T).set(S,h),E(this,M).call(this,{id:S,version:D,path:"on."+e,args:[r]}),()=>{E(this,T).delete(S),setTimeout(()=>{this.postMessage({id:S,path:"off."+e,args:[r]})},0)}}),i(this,"disconnect",()=>{E(this,u)&&this.postMessage({id:this.id,path:Y.DISCONNECT})}),i(this,"echo",e=>this.sendRequest(R.ECHO,e)),i(this,"requestPermissions",e=>this.sendRequest(R.REQUEST_PERMISSIONS,e)),i(this,"getSession",async()=>this.sendRequest(H.GET_SESSION)),i(this,"setBadge",e=>this.sendRequest(B.SET_BADGE,e)),i(this,"pushNotification",e=>this.sendRequest(U.PUSH,e)),i(this,"clearNotifications",e=>this.sendRequest(U.CLEAR,e)),i(this,"setStoreItem",(e,r,h)=>this.sendRequest(d.SET_ITEM,e,r,h)),i(this,"getStoreItem",async(e,r,h)=>this.sendRequest(d.GET_ITEM,e,h).then(S=>S??r?r:S)),i(this,"removeStoreItem",(e,r)=>this.sendRequest(d.REMOVE_ITEM,e,r)),i(this,"onSessionChange",e=>this.subscribe(H.ON_CHANGE,"*",e)),i(this,"onResourceChange",(e="*",r)=>this.subscribe(w.ON_CHANGE,e,r)),i(this,"onMessage",e=>this.subscribe(U.ON_CLICK,"*",e)),i(this,"onUserChange",e=>()=>this.subscribe(k.ON_CHANGE,"*",e)),n&&C(this,g,n.requestTimeout||0),this.id=f(),C(this,u,s),o.addEventListener("message",e=>{const{id:r,data:h,error:S}=e.data,O=E(this,N).get(r);if(O)O.timer&&clearTimeout(O.timer),E(this,N).delete(r),S?O.reject(S):O.resolve(h);else{const l=E(this,T).get(r);l&&l(h)}})}}I=new WeakMap,_=new WeakMap,N=new WeakMap,T=new WeakMap,g=new WeakMap,y=new WeakMap,u=new WeakMap,P=new WeakMap,M=new WeakMap;class F extends ${constructor(s,o){super(s,s,o),i(this,"query",async n=>{const e=typeof n=="string"?n:n.toString();return await this.sendRequest(Z.QUERY,e)}),i(this,"openApp",(n,e)=>this.sendRequest(R.OPEN_APP,{appId:n,message:e})),i(this,"setResource",n=>this.sendRequest(w.SET_RESOURCE,n)),i(this,"clearResource",n=>this.sendRequest(w.CLEAR_RESOURCE,n)),i(this,"setUser",n=>this.sendRequest(k.SET_USER,n)),i(this,"sendMessage",n=>this.sendRequest(R.SEND_MESSAGE,n)),i(this,"generatePathFromProxy",n=>{const e=[],r={get(h,S){return e.push(S.toString()),new Proxy(()=>{},r)},apply(h,S,O){const l=O.map(ee=>JSON.stringify(ee)).join(", "),W=e[e.length-1];return W==="toString"?e.slice(0,-1).join("."):(e[e.length-1]=`${W}(${l})`,new Proxy(()=>{},r))}};return new Proxy(()=>{},r)}),i(this,"requestPermissions",n=>this.sendRequest(R.REQUEST_PERMISSIONS,n))}}let q;const J=()=>{if(!p)throw new Error("usePortalService must be called from a web worker");return q||(q=new F(self)),q};(async function(){try{const t=J();let s;t.subscribe(X.ON_URL_CHANGE,"",o=>{o.includes("login")&&s?(s=null,t.setUser()):s||t.sendRequest(d.GET_LOCAL_STORAGE_ITEM,"ehrUser").then(n=>{if(n){s=JSON.parse(n);try{s.id&&t.setUser({id:s.id})}catch{t.setUser()}}})})}catch(t){console.error(t)}})()})();
